# File Readers

File readers are a way for [FrameReader](../api/Optispeech.Data.FileReaders.FrameReader.yml) to read data frames from different file formats. This is used in the [FileDataSource](../api/Optispeech.Data.Sources.FileDataSource.yml) and [CustomMotionTargetController](../api/Optispeech.Targets.Controllers.CustomMotionTargetController.yml). Each format should have its own file reader. This document will discuss how to add a new file reader to OptiSpeech 2. 

## Implement [FileReader](../api/Optispeech.Data.FileReaders.FrameReader.FileReader.yml)

Your implementation must implement the following abstract methods:

- [`void ReadFrames(StreamReader file, UnityAction<DataFrame> addDataFrame, UnityAction<bool> finish)`](../api/Optispeech.Data.FileReaders.FrameReader.FileReader.yml#Optispeech_Data_FileReaders_FrameReader_FileReader_ReadFrames_System_IO_StreamReader_UnityEngine_Events_UnityAction_Optispeech_Data_DataFrame__UnityEngine_Events_UnityAction_System_Boolean__) - Given a file, read any data frames from it and call `addDataFrame` on each one. Call `finish` before exiting the function. You can pass `true` if the file was read successfully, and `false` otherwise. This function will be called in a background thread.
- [`SensorConfiguration[] GetSensorConfigurations(DataFrame dataFrame)`](../api/Optispeech.Data.FileReaders.FrameReader.FileReader.yml#Optispeech_Data_FileReaders_FrameReader_FileReader_GetSensorConfigurations_Optispeech_Data_DataFrame_) - Given an already create DataFrame generated by this file reader, get the sensor configurations for that frame. In some cases the data frame may be ignored and the sensor configurations are determined by the header of the file, or may even be the same for all files this reader supports. 

Click each link to see more specific information on implementing each function.

Additionally, there's a [`string GetAudioFile(string filename)`](../api/Optispeech.Data.FileReaders.FrameReader.FileReader.yml#Optispeech_Data_FileReaders_FrameReader_FileReader_GetAudioFile_System_String_) function that's called to determine where the audio file is for a given data file, if it exists. By default it just replaced the file extension with `.wav`, but this function can be overriden if there's a file format-specific way to find the audio file. It is not required to check if the audio file does in fact exist, this function just reports where it *would* exist, if it does.

The constructor can be created however you'd like. Since you'll be manually writing the code to instantiate this file reader (due to reasons described in the section below), you have full control over giving it the information it needs to be constructed. This may involve parsing the first so many lines of the file, as a "header", so that the first line next to be read is a data frame line. 

Several file formats can have similar designs or patterns, so [FrameReader](../api/Optispeech.Data.FileReaders.FrameReader.yml) contains the following utility functions to handle common use cases:

- [`bool ReadSingleLineFrames(StreamReader file, UnityAction<DataFrame> addDataFrame, FrameReader.ReadFrameFromString readFrame)`](../api/Optispeech.Data.FileReaders.FrameReader.yml#Optispeech_Data_FileReaders_FrameReader_ReadSingleLineFrames_System_IO_StreamReader_UnityEngine_Events_UnityAction_Optispeech_Data_DataFrame__Optispeech_Data_FileReaders_FrameReader_ReadFrameFromString_) - This can help when reading a file that will have a single line for each data frame. It takes the file, the `addDataFrame` delegate, and your own function that can be a valid [`FrameReader.ReadFrameFromString`](../api/Optispeech.Data.FileReaders.FrameReader.ReadFrameFromString.yml) that takes a single-line string and returns a dataframe. It'll return whether or not it read through the whole file successfully.
- [`bool HandleFailure(string message, ref int numFailures)`](../api/Optispeech.Data.FileReaders.FrameReader.yml#Optispeech_Data_FileReaders_FrameReader_HandleFailure_System_String_System_Int32__) - This can handle writing messages to the console and checking if enough errors have occured to determine if this file is invalid. Note that you pass in the number of failures, and the function will increment it and check its value for you

If any part is confusing, it's recommended to read through any of the existing file readers to use as a reference.

## Update [FrameReader.GetFileReader](../api/Optispeech.Data.FileReaders.FrameReader.yml#Optispeech_Data_FileReaders_FrameReader_GetFileReader_System_IO_StreamReader_)

Currently there is no standardized way to determine which file reader to use for a given file. The logic to determine which to use is written inside the aforementioned function. Whenever adding a new file reader that function will need to be updated to add logic for when to use the new file reader. This may (hopefully) change in the future to dynamically discovering file reader implementations and call a function on each to determine if that file reader can understand the given file.  
